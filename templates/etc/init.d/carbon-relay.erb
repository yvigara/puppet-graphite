#!/bin/sh
# !!! generated by puppet !!!

# chkconfig: 345 80 20
# description: Start/Stop carbon-relay
# processname: carbon-relay
# config: /etc/carbon/carbon.conf

### BEGIN INIT INFO
# Provides: carbon-relay
# Required-Start: $local_fs $network $remote_fs
# Required-Stop: $local_fs $network $remote_fs
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: Start/Stop carbon-relay
# Description: Enables Graphites carbon-relay
### END INIT INFO

# Source function library.
. /etc/rc.d/init.d/functions

[ -e /etc/sysconfig/carbon ] && . /etc/sysconfig/carbon

CARBON_DAEMON="relay"
exec="/usr/bin/carbon-relay"
CONFIG="/etc/carbon/carbon.conf"
LOG_DIR="/var/log/carbon"
pidfile=""
OPERATION="$1"
if [ $# -gt 1 ]; then
    shift
    INSTANCES=$@
else
    INSTANCES=`grep "^\[${CARBON_DAEMON}" ${CONFIG} | cut -d \[ -f 2 | cut -d \] -f 1 | cut -d : -f 2`
fi

start()
{
    for INSTANCE in ${INSTANCES}; do
        if [ "${INSTANCE}" == "${CARBON_DAEMON}" ]; then
            INSTANCE="a";
        fi;
        pidfile=/var/run/carbon-${CARBON_DAEMON}-${INSTANCE}.pid
        prog=carbon-${CARBON_DAEMON}-${INSTANCE}
        # check if instance is already running
        rh_status_q && continue

        echo -n $"Starting carbon-${CARBON_DAEMON}:${INSTANCE}..."
        daemon "$exec --config=$CONFIG --pidfile=$pidfile --logdir=$LOG_DIR --instance=${INSTANCE} start"
        retval=$?
        if [ rh_status_q ]; then
            touch /var/lock/subsys/carbon-${CARBON_DAEMON}-${INSTANCE}
            echo_success
            echo
        else
            echo_failure
            echo
            exit 1
        fi
    done
    return $retval
}

stop()
{
    for INSTANCE in ${INSTANCES}; do
        if [ "${INSTANCE}" == "${CARBON_DAEMON}" ]; then
            INSTANCE="a";
        fi;
        pidfile=/var/run/carbon-${CARBON_DAEMON}-${INSTANCE}.pid
        prog=carbon-${CARBON_DAEMON}-${INSTANCE}
        # check if instance is already stopped
        rh_status_q || continue

        killproc -p $pidfile `basename $exec`
        retval=$?
        echo
        [ $retval -eq 0 ] && rm -f /var/lock/subsys/carbon-${CARBON_DAEMON}-${INSTANCE}
        echo -n $"Stopping carbon-${CARBON_DAEMON}:${INSTANCE}..."
        echo_success
        echo
    done
    return 0
}

restart() {
    # To be sure that at least one intance is always running during restart,
    # we will restart one instance at a time.
    for INSTANCE in ${INSTANCES}; do
        if [ "${INSTANCE}" == "${CARBON_DAEMON}" ]; then
            INSTANCE="a";
        fi;
        pidfile=/var/run/carbon-${CARBON_DAEMON}-${INSTANCE}.pid
        prog=carbon-${CARBON_DAEMON}-${INSTANCE}

        killproc -p $pidfile `basename $exec`
        retval=$?
        echo
        [ $retval -eq 0 ] && rm -f /var/lock/subsys/carbon-${CARBON_DAEMON}-${INSTANCE}
        echo -n $"Stopping carbon-${CARBON_DAEMON}:${INSTANCE}..."
        echo_success
        echo

        echo -n $"Starting carbon-${CARBON_DAEMON}:${INSTANCE}..."
        daemon "$exec --config=$CONFIG --pidfile=$pidfile --logdir=$LOG_DIR --instance=${INSTANCE} start"
        retval=$?
        if [ rh_status_q ]; then
            touch /var/lock/subsys/carbon-${CARBON_DAEMON}-${INSTANCE}
            echo_success
            echo
        else
            echo_failure
            echo
            exit 1
        fi
    done
    return $retval
}

reload() {
    restart
}

force_reload() {
    restart
}

rh_status() {
    status -p $pidfile $prog
}

rh_status_q() {
    rh_status >/dev/null 2>&1
}

case "${OPERATION}" in
    start)
        $1
        ;;
    stop)
        $1
    ;;
    restart)
        $1
        ;;
    reload)
        $1
        ;;
    force-reload)
        force_reload
        ;;
    condrestart|try-restart)
        # TODO: bad behavior. only checking instance "a" at the moment
        pidfile=/var/run/carbon-${CARBON_DAEMON}-a.pid
        prog=carbon-${CARBON_DAEMON}-a
        rh_status_q || exit 0
        restart
        ;;
    status)
        for INSTANCE in ${INSTANCES}; do
            if [ "${INSTANCE}" == "${CARBON_DAEMON}" ]; then
                INSTANCE="a";
            fi;
            pidfile=/var/run/carbon-${CARBON_DAEMON}-${INSTANCE}.pid
            prog=carbon-${CARBON_DAEMON}-${INSTANCE}
            rh_status
        done
        ;;
    *)
        echo "Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload} [instance instance ...]"
        exit 2
esac
exit $?
